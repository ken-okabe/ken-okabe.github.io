:::lang-en

# Chapter 8: Advanced Debugging System

The Timeline library provides an advanced debugging system that is also extremely effective for AI coding.

## 1. Activation and Control: Flexible Debug Mode Management

Debug mode can be flexibly activated in various environments.

* **Automatic Detection Based on Environment**:
    * **Node.js**: Activated when the environment variable `process.env.NODE_ENV === 'development'`.
    * **Browser**: Automatically enabled when a development environment is inferred, such as through a URL parameter (`?debug=true`), a `localStorage` flag (`timeline-debug: 'true'`), or access from `localhost` or specific IP addresses.
* **Manual Control via API**:
    * Using the `DebugControl` object, you can change persistent settings by calling `enable()` / `disable()` from the developer console (requires a reload).
    * `enableTemporary()` can be used to temporarily activate it for the current session without a reload.

---

## 2. Information Gathering: Complete Recording of All Dependencies

When debug mode is enabled, `DependencyCore` records its internal operations in detail.

* **Illusion**: Groups of dependencies generated by `bind`, `using`, etc., are recorded as `DebugInfo`. This includes their own ID, an array of their `dependencyIds`, creation time, and a **`parentIllusion`** ID to construct the tree structure.
* **Dependency**: Individual dependencies are recorded as `DependencyDebugInfo`. This includes detailed metadata such as their own ID, `sourceId` (from which timeline), `targetId` (to which timeline), the `illusionId` they belong to, the presence of a cleanup function (`hasCleanup`), and creation time.

---

## 3. Runtime Protection: Run-time Guard Against Circular References

When debug mode is enabled, the `define` function uses a `Set` called `currentlyUpdating` to monitor whether a data update has entered an infinite loop. If the same timeline is about to be updated again during the same update process, it is identified as a circular reference, a warning is output to the console, and the process is interrupted.

---

## 4. Developer API: Visualization and Manipulation of Information

The collected information can be accessed and visualized through the `DebugUtils` object.

* **`getInfo()`**: You can get the **raw data** arrays of all recorded illusions and dependencies, as well as their **total counts** (`totalIllusions`, `totalDependencies`), as an object.
* **`printTree()`**: This is the most powerful feature of the debugging system.
    * **Display of Tree Structure**: Based on the collected `parentIllusion` information, it reconstructs the parent-child relationships of the illusions. Then, using `console.group`, it displays a hierarchically indented **dependency tree** on the console.
    * **Detailed Information**: For each illusion in the tree, its ID, parent ID, creation time, and the number of dependencies it contains are displayed. Below that, for each of its dependencies, details such as its ID, the source and target timeline IDs, and the presence of a cleanup function are shown.

These features allow developers to deeply understand the internal state of the system and efficiently diagnose complex problems.

:::

:::lang-ja

# Chapter 8: 高機能なDebugシステム

Timelineライブラリは高機能なDebugシステムを提供しており、AIコーディングにも極めて有効に機能します。

## 1. 有効化と制御：柔軟なデバッグモード管理

デバッグモードは、多様な環境で柔軟に有効化できます。

* **環境に応じた自動検知**:
    * **Node.js**: 環境変数 `process.env.NODE_ENV === 'development'` で有効化。
    * **ブラウザ**: URLパラメータ (`?debug=true`)、`localStorage` のフラグ (`timeline-debug: 'true'`)、または`localhost`や特定のIPアドレスでのアクセスといった、開発環境と推定される場合に自動で有効になります。
* **APIによる手動制御**:
    * `DebugControl` オブジェクトを使い、開発者コンソールから`enable()` / `disable()`を呼び出して永続的な設定の変更が可能です（リロードが必要）。
    * `enableTemporary()`を使えば、リロード不要でそのセッション中だけ一時的に有効化することもできます。

---

## 2. 情報収集：全ての依存関係の完全な記録

デバッグモードが有効になると、`DependencyCore`は内部的な動作を詳細に記録します。

* **イリュージョン（Illusion）**: `bind`や`using`などで生成される依存関係のグループが`DebugInfo`として記録されます。これには、自身のID、所属する`dependencyIds`の配列、生成時刻、そしてツリー構造を構築するための**`parentIllusion`** IDが含まれます。
* **依存関係（Dependency）**: 個々の依存関係は`DependencyDebugInfo`として記録されます。これには、自身のID、`sourceId`（どのタイムラインから）、`targetId`（どのタイムラインへ）、所属する`illusionId`、クリーンアップ関数の有無（`hasCleanup`）、生成時刻といった詳細なメタデータが含まれます。

---

## 3. ランタイム保護：循環参照の実行時ガード

デバッグモード有効時、`define`関数は`currentlyUpdating`という`Set`を用いて、データ更新が無限ループに陥っていないかを監視します。もし同一の更新処理中に同じタイムラインが再度更新されようとした場合、循環参照と判断し、コンソールに警告を出力して処理を中断します。

---

## 4. 開発者向けAPI：情報の可視化と操作

`DebugUtils`オブジェクトを通じて、収集された情報にアクセスし、可視化することができます。

* **`getInfo()`**: 記録された全てのイリュージョンと依存関係の**生データ**配列、およびそれぞれの**総数**（`totalIllusions`, `totalDependencies`）をオブジェクトとして取得できます。
* **`printTree()`**: これがデバッグシステムの最も強力な機能です。
    * **ツリー構造の表示**: 収集した`parentIllusion`の情報を元に、イリュージョンの親子関係を再構築します。そして`console.group`を使い、コンソール上で階層的にインデントされた**依存関係ツリー**を表示します。
    * **詳細な情報**: ツリー内の各イリュージョンには、そのID、親ID、生成時刻、含まれる依存関係の数が表示されます。さらにその下には、所属する各依存関係について、そのID、ソースとターゲットのタイムラインID、クリーンアップ関数の有無などが詳しく表示されます。

以上の機能群により、開発者はシステムの内部状態を深く理解し、複雑な問題の診断を効率的に行うことが可能になっています。

:::